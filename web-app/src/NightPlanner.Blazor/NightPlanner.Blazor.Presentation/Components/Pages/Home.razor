@page "/"
@using NightPlanner.Blazor.Presentation.ApiClients.TaskTracker
@using NightPlanner.Blazor.Presentation.ApiClients.TaskTracker.Requests
@using NightPlanner.Blazor.Presentation.ApiClients.TaskTracker.Responses
@using NightPlanner.Blazor.Presentation.ApiServices.Contracts
@using NightPlanner.Blazor.Presentation.Models
@using NightPlanner.Blazor.Presentation.Components.Modals.Challenges
@inject ITelegramAuthenticationService TelegramAuthenticationService
@inject IChallengesApi ChallengesApi
<PageTitle>Home</PageTitle>

<div>
    <button @onclick="LoadChallenges">Загрузить</button>

    @foreach (var challenge in _challenges)
    {
        <div><b>@challenge.Name</b> - @challenge.Description</div>
    }
</div>

<div>
    <CreateModalForm OnChallengeCreated="LoadChallenges"/>
</div>

@code {
    private TelegramUser? _user;
    private string? _taskName;
    private string? _taskDesc;
    private IReadOnlyCollection<ChallengeResponse> _challenges = Array.Empty<ChallengeResponse>();
    
    private async Task LoadUserId()
    {
        _user = await TelegramAuthenticationService.GetTelegramUser();
    }

    private async Task CreateChallenge()
    {
        var challenge = new CreateChallengeRequest
        {
            UserId = await TelegramAuthenticationService.GetTelegramUserId(),
            Name = _taskName!,
            Description = _taskDesc
        };
        await ChallengesApi.CreateChallenge(challenge);
    }

    private async Task LoadChallenges()
    {
        var userId = await TelegramAuthenticationService.GetTelegramUserId();
        _challenges = await ChallengesApi.GetChallenges(userId);
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            await LoadChallenges();
        }
    }

}